# 数据炼金工坊 - Claude记忆文档

## 项目概述
**项目名称**: 抖音电商数据清洗系统（数据炼金工坊）  
**项目路径**: `/media/qinshu/969EB28D733D99C4/数据分析系统/dy-ec-cleaner/`  
**核心功能**: 智能解析和清洗蝉妈妈导出的抖音电商数据，将模糊数值范围转换为精确数值

## 系统架构

### 1. 核心引擎模块
**文件**: `app/core/etl_douyin.py`
- **管道架构师**设计的高性能数据处理引擎
- 基于Polars的数据处理框架
- 支持CSV和Excel文件格式

**核心功能**:
- 智能编码检测（支持UTF-8-SIG、GBK等）
- 多表格式解析（识别6种表格类型）
- 模糊数值转换（如"7.5w~10w" → min:75000, max:100000, avg:87500）
- 字段映射（中文→英文标准名）

### 2. Web界面模块
**文件**: `app/ui/streamlit_app.py`
- **界面设计师**创建的Streamlit Web应用
- 极简美学设计，渐变色UI
- 支持拖拽上传和批量处理

**界面功能**:
- 文件上传（CSV/Excel）
- 表格选择（6种数据基准）
- 数据过滤（快速过滤/自定义过滤）
- 结果下载（清洗后的CSV）

### 3. 配置文件
**文件**: `app/config/field_map.yml`
- 中文字段到英文字段的映射配置
- 数据类型定义
- 必填字段设置

## 关键技术修复记录

### 1. BOM处理和编码问题
**问题**: 蝉妈妈导出的文件可能包含BOM字符，导致表头识别失败  
**解决**: 
- CSV读取时自动使用`utf-8-sig`编码
- 智能分隔符检测（制表符、逗号）

### 2. 表头识别算法优化
**问题**: 原算法无法准确识别多表格式的表头  
**解决**: 
- 扩展关键词库（20+个关键词）
- 多维度判断（关键词匹配、非空单元格数、占比）
- 降级处理机制

### 3. 数据流修复
**问题**: 下载的是原始数据而非清洗后的数据  
**解决**: 
- 在表格选择后立即调用`clean_common_fields`
- 确保所有下载数据都经过清洗处理

### 4. 系统稳定性
**问题**: Streamlit进程容易被终止  
**解决**: 
- 创建独立启动脚本`run_web.sh`
- 精确的进程管理（只清理特定端口）
- 持久化日志系统`streamlit.log`

## 数据基准支持

系统能够完整识别和处理以下6种抖音电商数据表格：

1. **SKU商品库** - 商品信息、销量、销售额、佣金比例
2. **抖音销量榜** - 排名、商品、蝉妈妈链接、销量
3. **抖音热推榜** - 排名、商品、带货达人、转化率
4. **潜力爆品榜** - 排名、商品、佣金比例、昨日销量
5. **持续好货榜** - 排名、商品、近90天销量
6. **历史同期榜** - 排名、商品、同期销量

## 快速使用指南

### 启动Web界面
```bash
cd /media/qinshu/969EB28D733D99C4/数据分析系统/dy-ec-cleaner/
./run_web.sh
# 访问 http://localhost:8502
```

### 查看日志
```bash
tail -f streamlit.log
```

### 运行测试
```bash
source venv/bin/activate
python -m pytest tests/
```

### 命令行处理
```bash
source venv/bin/activate
python -m app.cli.main process data/input.csv -o data/output.parquet
```

## 系统特色

1. **智能解析** - 自动识别文件编码和表格结构
2. **模糊值处理** - 将范围值转换为min/max/avg三列
3. **批量处理** - 支持多文件同时处理
4. **数据过滤** - 灵活的列选择和行数限制
5. **质量报告** - 完整的数据统计和可视化

## 技术栈

- **数据处理**: Polars (高性能DataFrame库)
- **Web框架**: Streamlit
- **可视化**: Plotly
- **文件处理**: pandas, openpyxl
- **编码检测**: chardet

## 维护说明

1. **添加新的表格类型**: 在`_detect_tables_in_sheet`函数中添加关键词
2. **修改字段映射**: 编辑`app/config/field_map.yml`
3. **调整模糊值处理**: 修改`parse_fuzzy_numeric_range`函数
4. **更改端口**: 编辑`run_web.sh`中的PORT变量

## 常见问题

1. **Q: 为什么有些表格识别不到？**  
   A: 检查表头是否包含足够的关键词（至少2-3个）

2. **Q: 下载的数据没有_min/_max/_avg列？**  
   A: 确保原始数据包含模糊范围值（如"1万-5万"）

3. **Q: Web界面连接错误？**  
   A: 运行`./run_web.sh`重启服务，查看`streamlit.log`

## 联系支持

- **管道架构师**: 核心引擎问题
- **界面设计师**: UI/UX问题
- **整合工程师**: 系统部署问题

---

最后更新: 2025-06-21  
版本: 1.0.0  
状态: 生产就绪